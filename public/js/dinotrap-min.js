var App=Em.Application.create(),util={};App.Player=Ember.Object.create({points:0,traps:"infinite",name:null,id:null});var map,playerMarker;App.Geo=Ember.Object.create({status:"Inactive",lat:0,lon:0,accuracy:0});App.wid=null;App.outsideGameZoneWarning=!1;App.maphidden=!0;
App.startGeo=function(){console.log("startGeo");navigator.geolocation?(App.Geo.set("status","Pinging"),App.wid=navigator.geolocation.watchPosition(function(a){var b=a.coords.latitude,c=a.coords.longitude,a=a.coords.accuracy;if(-77.59>c||-76.65<c||39.21<b||38.6>b)b=38.9094,c=-77.0426,a=1,App.outsideGameZoneWarning||(alert("You are outside Washington D.C., so I am placing you at Dupont Circle."),App.outsideGameZoneWarning=!0);200<a?App.Geo.set("status","Waiting for Accuracy"):(navigator.geolocation.clearWatch(App.wid),
App.wid=null,App.Geo.set("status","Stopped"),App.maphidden&&($("div#logincontainer").hide(),$("div#loading").hide(),$("div#game").show()),map?App.updatePlayerPositionAcc(b,c,a):App.startMap(b,c,a))},function(a){a="LocError: "+a;console.log(a);App.Geo.set("status",a)},{enableHighAccuracy:!0,maximumAge:1E4,timeout:5E3})):(console.log("GeoLocation not supported"),App.Geo.set("status","GeoLocation not supported"))};
App.adjustMapSize=function(){var a=document.documentElement.clientWidth,b=Math.min(window.screen.height,document.documentElement.clientHeight);$("#map_canvas").css("height",b).css("width",a);window.top.scrollTo(0,1);a=new google.maps.LatLng(App.Geo.get("lat"),App.Geo.get("lon"));map&&map.setCenter(a)};
App.startMap=function(a,b,c){console.log("startMap");App.Geo.set("lat",a);App.Geo.set("lon",b);App.Geo.set("accuracy",c);window.addEventListener("onorientationchange"in window?"orientationchange":"resize",function(){App.adjustMapSize()},!1);App.adjustMapSize();c={center:new google.maps.LatLng(a,b),zoom:16,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1,mapTypeControl:!1,disableDefaultUI:!0,disableDoubleClickZoom:!0,scaleControl:!1,zoomControl:!1,styles:[{stylers:[{visibility:"off"}]},
{featureType:"landscape",stylers:[{visibility:"on"},{invert_lightness:!0}]},{featureType:"road",stylers:[{visibility:"on"},{lightness:-41},{saturation:-79},{hue:"#9900ff"}]},{featureType:"transit",stylers:[{visibility:"on"}]},{}]};map=new google.maps.Map(document.getElementById("map_canvas"),c);playerMarker=new MarkerWithLabel({position:new google.maps.LatLng(a,b),icon:"/images/j.png",map:map,labelContent:"Connecting ...",labelAnchor:new google.maps.Point(40,0),labelClass:"notloggedin",labelStyle:{opacity:0.75},
clickable:!1});google.maps.event.addListener(map,"dragend",function(){var a=map.getCenter();App.updatePlayerPosition(a.lat(),a.lng())});App.startSocket()};App.newPlayerName=function(a){playerMarker.setMap(null);playerMarker=new MarkerWithLabel({position:new google.maps.LatLng(App.Geo.get("lat"),App.Geo.get("lon")),icon:"/images/j.png",labelContent:a,labelAnchor:new google.maps.Point(40,0),labelClass:"playerlabel",labelStyle:{opacity:0.75},clickable:!1,map:map})};
App.updatePlayerPosition=function(a,b){App.updatePlayerPositionAcc(a,b,-1)};App.updatePlayerPositionAcc=function(a,b,c){App.Geo.set("lat",a);App.Geo.set("lon",b);App.Geo.set("accuracy",c);c=new google.maps.LatLng(a,b);map&&map.panTo(c);playerMarker.setPosition(c);App.notifyServerOfPostion(App.Player.get("name"),App.Player.get("id"),a,b)};App.otherPlayers={};
App.otherPlayer=function(a){if(App.Player.id!==a.id)if(App.otherPlayers[a.id]){var b=App.otherPlayers[a.id].marker;App.otherPlayers[a.id].lat=a.lat;App.otherPlayers[a.id].lon=a.lon;a=new google.maps.LatLng(a.lat,a.lon);b.setPosition(a)}else App.otherPlayers[a.id]=a,App.otherPlayers[a.id].marker=new MarkerWithLabel({position:new google.maps.LatLng(a.lat,a.lon),icon:"/images/j-bw.png",labelContent:a.name,labelAnchor:new google.maps.Point(40,0),labelClass:"playerlabel",labelStyle:{opacity:0.75},clickable:!1,
map:map})};App.placeDate=function(){var a=new Date;return Date.UTC(1900+a.getYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds(),a.getMilliseconds())};App.dirtyList={};App.dinos={};App.clearDirtyList=function(){for(var a in App.dirtyList)delete App.dirtyList[a]};App.markDinosForDelete=function(){App.clearDirtyList();for(var a in App.dinos)App.dirtyList[a]={dirty:!0}};App.removeFromDirtyList=function(a){App.dirtyList[a]&&delete App.dirtyList[a]};
App.deleteMarkedDinos=function(){for(var a in App.dirtyList)App.dinos[a]&&App.dinos[a].marker.setMap(null),App.dinos[a]&&delete App.dinos[a];App.clearDirtyList()};
App.placeDino=function(a){App.removeFromDirtyList(a.id);App.dinos[a.id]?(dMarker=App.dinos[a.id].marker,dMarker.placeDate=App.placeDate(),dMarker.lat=a.lat,dMarker.lon=a.lon,a=new google.maps.LatLng(a.lat,a.lon),dMarker.setPosition(a)):(App.dinos[a.id]=a,App.dinos[a.id].placeDate=App.placeDate(),App.dinos[a.id].marker=new google.maps.Marker({clickable:!1,icon:"/images/trex.png",position:new google.maps.LatLng(a.lat,a.lon),map:map}))};App.traps={};
App.clearCircles=function(){for(var a in App.traps)App.traps[a].circle.setMap(null),delete App.traps[a]};App.drawTrap=function(a){var b=a.survivorGuid?a.survivorGuid:a.survivorId;App.traps[a.guid]=a;var c=a.location.split(","),b=b===App.Player.get("id")?"#0000EE":"#EE00EE",c={strokeColor:b,strokeOpacity:0.8,strokeWeight:2,fillColor:b,fillOpacity:0.35,map:map,center:new google.maps.LatLng(c[0],c[1]),radius:1609.344*a.distance};App.traps[a.guid].circle=new google.maps.Circle(c)};
App.handleDinos=function(a){App.markDinosForDelete();$.each(a.dinos,function(a,c){App.placeDino(c)});App.clearCircles();$.each(a.traps,function(a,c){App.drawTrap(c)});App.deleteMarkedDinos()};App.Comms=Ember.Object.create({status:"Server Communication Inactive"});App.isLoggedIn=!1;
App.startSocket=function(){console.log("startSocket");App.Comms.set("status","Attempting");App.socket=io.connect("/");App.socket.on("connect",function(){console.log("comms established");App.Comms.set("status","Server Connected");App.socket.on("connect_failed",function(){App.Comms.set("status","Failed")});App.socket.on("login-accepted",function(a){App.isLoggedIn=!0;App.Comms.set("status","DinoTrap (beta)");App.Player.set("name",a.name);App.newPlayerName(a.name);App.Player.set("id",a.id);App.Player.set("points",
a.points);$("#trapButton").show();App.nearMe()});App.socket.on("otherPlayerPosition",function(a){App.otherPlayer(a)});App.socket.on("newDinosAvailable",function(){App.nearMe()});App.socket.on("thingsNearYou",function(a){App.handleDinos(a)});App.socket.on("trapPlaced",function(a){App.drawTrap(a)});App.socket.on("trap-spring",function(a){App.Player.get("id")===a.survivorId&&(App.Player.set("points",a.points),alert("A dino walked into your trap.  You now have "+a.points+" points!"),App.nearMe())});if(!App.isLoggedIn){var a=
App.Player.get("name"),b=App.Geo.get("lat"),c=App.Geo.get("lon");null!==a&&(0!==b&&0!==c)&&App.attemptLogin(a,b,c)}})};App.nearMe=function(){App.socket.emit("nearMe",{name:App.Player.get("name"),id:App.Player.get("id"),lat:App.Geo.get("lat"),lon:App.Geo.get("lon")})};App.attemptLogin=function(a,b,c){App.socket.emit("login",{name:a,lat:b,lon:c})};App.notifyServerOfPostion=function(a,b,c,d){App.isLoggedIn&&App.socket.emit("myPosition",{name:a,id:b,lat:c,lon:d})};
App.placeTrap=function(){App.socket.emit("placeTrap",{name:App.Player.get("name"),id:App.Player.get("id"),lat:App.Geo.get("lat"),lon:App.Geo.get("lon")})};App.trapFlag=!1;App.trap=function(){App.trapFlag||(App.trapFlag=!0,setTimeout(function(){App.trapFlag=!1},1E3),App.placeTrap())};App.loginFlag=!1;App.login=function(){App.loginFlag||(App.loginFlag=!0,setTimeout(function(){App.loginFlag=!1},400),$("#loginButton").hide(),$("#loginPopup").show())};
App.loginGo=function(){var a=$("input#name").val().toLowerCase();App.attemptLogin(a,App.Geo.get("lat"),App.Geo.get("lon"))};App.recenterFlag=!1;App.recenterClick=function(){!App.recenterFlag&&null===App.wid&&(App.recenterFlag=!0,setTimeout(function(){App.recenterFlag=!1},400),App.startGeo())};App.gameStart=function(){App.startGeo()};
$(document).ready(function(){$("#loginform").bind("submit",function(a){a.preventDefault();a=$("input#username").val().toLowerCase();/^[\w\d]+$/.test(a)&&10>a.length?($("#loginform").hide(),$("#loading").show(),App.Player.set("name",a),App.gameStart()):alert("Please enter a valid name. Letters and Numbers.  Maximum 10 characters");return!1})});